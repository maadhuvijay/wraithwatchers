<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 05e26b26-5113-46bd-9fb5-e869a7d6e33e (2025-12-06 00:33Z) -->

# Debugging react maximum update depth error (2025-12-06 00:33Z)

_**User (2025-12-05 21:44Z)**_

getting the below error:

Console Error





Maximum update depth exceeded. This can happen when a component calls setState inside useEffect, but useEffect either doesn't have a dependency array, or one of the dependencies changes on every render.

Call Stack

52



createConsoleError

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_7a8122d0._.js (2189:71)

handleConsoleError

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_7a8122d0._.js (2970:54)

console.error

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_7a8122d0._.js (3114:57)

getRootForUpdatedFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (2992:143)

enqueueConcurrentHookUpdate

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (2975:16)

dispatchSetStateInternal

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (5667:22)

dispatchSetState

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (5640:9)

handleLocationSelect

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/_60bae5dd._.js (357:9)

LocationMap.useEffect.initializeMap

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/_60bae5dd._.js (265:21)

LocationMap.useEffect.loadLeaflet

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/_60bae5dd._.js (148:25)

LocationMap.useEffect

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/_60bae5dd._.js (269:13)

Object.react_stack_bottom_frame

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (14866:22)

runWithFiberInDEV

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (959:74)

commitHookEffectListMount

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (7260:167)

commitHookPassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (7295:60)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8690:33)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8751:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8751:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8751:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8751:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8751:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8751:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8694:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8694:17)

recursivelyTraversePassiveMountEffects

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8677:316)

commitPassiveMountOnFiber

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js (8689:17)

PostSighting

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/_60bae5dd._.js (592:239)

ClientPageRoot

file:///C:/Users/maadh/Git%20Local/AI-Accelerator/wraithwatchers/.next/dev/static/chunks/node_modules_next_dist_094231d7._.js (2202:50)

1

2

Was this helpful?









---

_**Agent (model default, mode Agent)**_



---


Examining `LocationMap.tsx` to identify the infinite update loop.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: app/components/LocationMap.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "handleLocationSelect function that calls setState" • **12** results</summary>
            
| File | Lines |
|------|-------|
| `app/components/LocationMap.tsx` | L8-167 |
| `app/components/LocationMap.tsx` | L4-167 |
| `app/components/LocationMap.tsx` | L167 |
| `app/post/page.tsx` | L6-117 |
| `app/post/page.tsx` | L117 |
| `app/page.tsx` | L122 |
| `app/components/SightingsMap.tsx` | L9-165 |
| `app/page.tsx` | L9-122 |
| `app/components/SightingsMap.tsx` | L165 |
| `app/lib/utils.ts` | L12-104 |
| `.next/dev/server/chunks/ssr/node_modules_ae1fc6df._.js` | L3326-3523 |
| `app/lib/utils.ts` | L16 |

</details>
</tool-use>

---



---


The issue: `onLocationSelect` is in the `useEffect` dependency array, but the parent passes a new function on each render, causing an infinite loop. Checking the parent component to fix it:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: app/post/page.tsx</summary>

</details>
</tool-use>

---



---


Fixing the infinite loop: `handleLocationSelect` is recreated on each render, and `LocationMap` includes `onLocationSelect` in its `useEffect` dependencies. Memoizing the callback in the parent and using a ref in `LocationMap` to avoid re-initializing the map.


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: app/post/page.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -1,5 +1,5 @@
  'use client';
  
- import { useState } from 'react';
+ import { useState, useCallback } from 'react';
  import { useRouter } from 'next/navigation';
  import Navbar from '../components/Navbar';
```

**Chunk 2**
Lines added: 2, lines removed: 2

```diff
@@ -25,7 +25,7 @@
    };
  
-   const handleLocationSelect = (lat: number, lng: number) =&gt; {
+   const handleLocationSelect = useCallback((lat: number, lng: number) =&gt; {
      setFormData(prev =&gt; ({ ...prev, latitude: lat, longitude: lng }));
-   };
+   }, []);
  
    return (
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: app/components/LocationMap.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -15,4 +15,5 @@
    const [selectedLocation, setSelectedLocation] = useState&lt;[number, number]&gt;([initialLat, initialLng]);
    const isInitializingRef = useRef(false);
+   const onLocationSelectRef = useRef(onLocationSelect);
  
    useEffect(() =&gt; {
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: app/components/LocationMap.tsx</summary>

**Chunk 1**
Lines added: 5, lines removed: undefined

```diff
@@ -16,4 +16,9 @@
    const isInitializingRef = useRef(false);
    const onLocationSelectRef = useRef(onLocationSelect);
+ 
+   // Keep the callback ref up to date
+   useEffect(() =&gt; {
+     onLocationSelectRef.current = onLocationSelect;
+   }, [onLocationSelect]);
  
    useEffect(() =&gt; {
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: app/components/LocationMap.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -125,5 +125,5 @@
          marker.setLatLng([lat, lng]);
          setSelectedLocation([lat, lng]);
-         onLocationSelect(lat, lng);
+         onLocationSelectRef.current(lat, lng);
        });
  
```

**Chunk 2**
Lines added: 2, lines removed: 2

```diff
@@ -132,9 +132,9 @@
          const { lat, lng } = e.target.getLatLng();
          setSelectedLocation([lat, lng]);
-         onLocationSelect(lat, lng);
+         onLocationSelectRef.current(lat, lng);
        });
  
        // Initial location selection
-       onLocationSelect(initialLat, initialLng);
+       onLocationSelectRef.current(initialLat, initialLng);
  
        isInitializingRef.current = false;
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: app/components/LocationMap.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -167,5 +167,5 @@
        }
      };
-   }, [initialLat, initialLng, onLocationSelect]);
+   }, [initialLat, initialLng]);
  
    return (
```

</details>

</tool-use>

---



---


Checking for linting errors:


---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 2 files</summary>
      
Lint paths:

- `app/post/page.tsx`
- `app/components/LocationMap.tsx`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


Fixed the infinite loop. Summary of changes:

## The Problem
- `handleLocationSelect` was recreated on every render in the parent component
- `LocationMap` included `onLocationSelect` in its `useEffect` dependency array
- When the callback updated state, it triggered a re-render, creating a new function reference, which re-ran the effect, causing an infinite loop

## The Solution
1. In `app/post/page.tsx`: Wrapped `handleLocationSelect` with `useCallback` to keep a stable reference
2. In `app/components/LocationMap.tsx`:
   - Added a ref (`onLocationSelectRef`) to store the latest callback
   - Removed `onLocationSelect` from the `useEffect` dependency array
   - Added a separate `useEffect` to keep the ref updated
   - Updated all `onLocationSelect` calls to use `onLocationSelectRef.current`

This prevents the map from re-initializing when the callback changes, while still using the latest callback. The infinite loop should be resolved.

---

